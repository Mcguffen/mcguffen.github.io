<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Webpack进阶Tree Shaking::: tip 理解Tree Shaking是一个术语，通常用于描述移除js中未使用的代码。:::::: warning 注意Tree Shaking 只适用于ES Module语法(既通过export导出，import引入)，因为它依赖于ES Module的静态结构特性。::: 在正式介绍Tree Shaking之前，我们需要现在src目录下新建一个ma">
<meta property="og:type" content="article">
<meta property="og:title" content="Webpack进阶">
<meta property="og:url" content="http://example.com/2020/11/18/docs/webpack/advanced/index.html">
<meta property="og:site_name" content="Hi! I am yang.">
<meta property="og:description" content="Webpack进阶Tree Shaking::: tip 理解Tree Shaking是一个术语，通常用于描述移除js中未使用的代码。:::::: warning 注意Tree Shaking 只适用于ES Module语法(既通过export导出，import引入)，因为它依赖于ES Module的静态结构特性。::: 在正式介绍Tree Shaking之前，我们需要现在src目录下新建一个ma">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-18T00:00:00.000Z">
<meta property="article:modified_time" content="2021-04-08T01:55:19.511Z">
<meta property="article:author" content="Mcguffen">
<meta property="article:tag" content="webpack">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Webpack进阶</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/Mcguffen?tab=repositories">项目</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/11/18/docs/webpack/source/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/11/17/docs/frontEnd/react/react06/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/11/18/docs/webpack/advanced/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/11/18/docs/webpack/advanced/&text=Webpack进阶"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/11/18/docs/webpack/advanced/&is_video=false&description=Webpack进阶"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Webpack进阶&body=Check out this article: http://example.com/2020/11/18/docs/webpack/advanced/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/11/18/docs/webpack/advanced/&name=Webpack进阶&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/11/18/docs/webpack/advanced/&t=Webpack进阶"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Webpack%E8%BF%9B%E9%98%B6"><span class="toc-number">1.</span> <span class="toc-text">Webpack进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tree-Shaking"><span class="toc-number">1.1.</span> <span class="toc-text">Tree Shaking</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SideEffects"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">SideEffects</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E5%88%86%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">区分开发模式和生产模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E7%A6%BB-CodeSplitting"><span class="toc-number">1.3.</span> <span class="toc-text">代码分离(CodeSplitting)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E8%BF%9B%E8%A1%8C%E5%88%86%E5%89%B2"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">手动进行分割</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">同步代码分割</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-number">1.3.0.3.</span> <span class="toc-text">异步代码分割</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SplitChunksPlugin%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.</span> <span class="toc-text">SplitChunksPlugin配置参数详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#chunks%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">chunks参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#minSize-%E5%92%8C-maxSize"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">minSize 和 maxSize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#minChunks"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">minChunks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#maxAsyncRequests-%E5%92%8C-maxInitialRequests"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">maxAsyncRequests 和 maxInitialRequests</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#automaticNameDelimiter"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">automaticNameDelimiter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheGroups"><span class="toc-number">1.4.0.6.</span> <span class="toc-text">cacheGroups</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E5%90%8D"><span class="toc-number">1.4.0.7.</span> <span class="toc-text">自定义文件名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lazy-Loading%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.5.</span> <span class="toc-text">Lazy Loading懒加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PreLoading-%E5%92%8CPrefetching"><span class="toc-number">1.6.</span> <span class="toc-text">PreLoading 和Prefetching</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSS%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-number">1.7.</span> <span class="toc-text">CSS代码分割</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CSS%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">CSS压缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Webpack%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98-Caching"><span class="toc-number">1.8.</span> <span class="toc-text">Webpack和浏览器缓存(Caching)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shimming"><span class="toc-number">1.9.</span> <span class="toc-text">Shimming</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%85%A8%E5%B1%80this%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.</span> <span class="toc-text">处理全局this指向问题</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Webpack进阶
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Mcguffen</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-11-18T00:00:00.000Z" itemprop="datePublished">2020-11-18</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/frontEnd/">frontEnd</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/webpack/" rel="tag">webpack</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Webpack进阶"><a href="#Webpack进阶" class="headerlink" title="Webpack进阶"></a>Webpack进阶</h1><h2 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree Shaking"></a>Tree Shaking</h2><p>::: tip 理解<br><code>Tree Shaking</code>是一个术语，通常用于描述移除<code>js</code>中未使用的代码。<br>:::<br>::: warning 注意<br>Tree Shaking 只适用于<code>ES Module</code>语法(既通过<code>export</code>导出，<code>import</code>引入)，因为它依赖于<code>ES Module</code>的静态结构特性。<br>:::</p>
<p>在正式介绍<code>Tree Shaking</code>之前，我们需要现在<code>src</code>目录下新建一个<code>math.js</code>文件，它的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a + b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">minus</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a - b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们对<code>index.js</code>做一下处理，它的代码像下面这样，从<code>math.js</code>中引用<code>add</code>方法并调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">&#x27;./math&#x27;</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>在上面的<code>.js</code>改动完毕后，我们最后需要对<code>webpack.config.js</code>做一下配置，让它支持<code>Tree Shaking</code>，它的改动如下：</p>
<figure class="highlight js"><figcaption><span>&#123;8,9,10&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;source-map&#x27;</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">&#x27;./src/index.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    usedExports: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">&#x27;main.js&#x27;</span>,</span><br><span class="line">    path: path.resolve(__dirname,<span class="string">&#x27;dist&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在以上<code>webpack.config.js</code>配置完毕后，我们需要使用<code>npx webpack</code>进行打包，它的打包结果如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dist/main.js</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="comment">/* harmony export (binding) */</span> </span><br><span class="line">__webpack_require__.d(__webpack_exports__, <span class="string">&quot;a&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> add; &#125;);</span><br><span class="line"><span class="comment">/* unused harmony export minus */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a + b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">minus</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(a - b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>打包结果分析</strong>：虽然我们配置了 <code>Tree Shaking</code>，但在开发环境下，我们依然能够看到未使用过的<code>minus</code>方法，以上注释也清晰了说明了这一点，这个时候你可能会问：为什么我们配置了<code>Tree Shaking</code>，<code>minus</code>方法也没有被使用，但依然还是被打包进了<code>main.js</code>中？<br/></p>
<p>其实这个原因很简单，这是因为我们处于开发环境下打包，当我们处于开发环境下时，由于<code>source-map</code>等相关因素的影响，如果我们不把没有使用的代码一起打包进来的话，<code>source-map</code>就不是很准确，这会影响我们本地开发的效率。<br/></p>
<p>看完以上本地开发<code>Tree Shaking</code>的结果，我们也知道了本地开发<code>Tree Shaking</code>相对来说是不起作用的，那么在生产环境下打包时，<code>Tree Shaking</code>的表现又如何呢？<br/></p>
<p>在生产环境下打包，需要我们对<code>webpack.config.js</code>中的<code>mode</code>属性，需要由<code>development</code>改为<code>production</code>，它的改动如下：</p>
<figure class="highlight js"><figcaption><span>&#123;3&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;source-map&#x27;</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">&#x27;./src/index.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    usedExports: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">&#x27;main.js&#x27;</span>,</span><br><span class="line">    path: path.resolve(__dirname,<span class="string">&#x27;dist&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完毕后，我们依然使用<code>npx webpack</code>进行打包，可以看到，它的打包结果如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dist/main.js</span></span><br><span class="line">([<span class="function"><span class="keyword">function</span>(<span class="params">e,n,r</span>)</span>&#123;</span><br><span class="line"><span class="meta">  &quot;use strict&quot;</span>;</span><br><span class="line">  <span class="keyword">var</span> t,o;</span><br><span class="line">  r.r(n),</span><br><span class="line">  t=<span class="number">1</span>,</span><br><span class="line">  o=<span class="number">4</span>,</span><br><span class="line">  <span class="built_in">console</span>.log(t+o)</span><br><span class="line">&#125;]);</span><br></pre></td></tr></table></figure>
<p><strong>打包代码分析</strong>：以上代码是一段被压缩过后的代码，我们可以看到，上面只有<code>add</code>方法，未使用的<code>minus</code>方法并没有被打包进来，这说明在生产环境下我们的<code>Tree Shaking</code>才能真正起作用。</p>
<h4 id="SideEffects"><a href="#SideEffects" class="headerlink" title="SideEffects"></a>SideEffects</h4><p>::: tip 说明<br>由于<code>Tree Shaking</code>作用于所有通过<code>import</code>引入的文件，如果我们引入第三方库，例如：<code>import _ from &#39;lodash&#39;</code>或者<code>.css</code>文件，例如<code>import &#39;./style.css&#39;</code> 时，如果我们不<br>做限制的话，Tree Shaking将起副作用，<code>SideEffects</code>属性能帮我们解决这个问题：它告诉<code>webpack</code>，我们可以对哪些文件不做 <code>Tree Shaking</code><br>:::</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改package.json</span></span><br><span class="line"><span class="comment">// 如果不希望对任何文件进行此配置，可以设置sideEffects属性值为false</span></span><br><span class="line"><span class="comment">// *.css 表示 对所有css文件不做 Tree Shaking</span></span><br><span class="line"><span class="comment">// @babael/polyfill 表示 对@babel/polyfill不做 Tree Shaking</span></span><br><span class="line"><span class="string">&quot;sideEffects&quot;</span>: [</span><br><span class="line">  <span class="string">&quot;*.css&quot;</span>,</span><br><span class="line">  <span class="string">&quot;@babel/polyfill&quot;</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p><strong>小结</strong>：对于<code>Tree Shaking</code>的争议比较多，推荐看:point_right:<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32831172">你的Tree Shaking并没有什么卵用</a>，看完你会发现我们对<code>Tree Shaking</code>的了解还需要进一步加深。</p>
<h2 id="区分开发模式和生产模式"><a href="#区分开发模式和生产模式" class="headerlink" title="区分开发模式和生产模式"></a>区分开发模式和生产模式</h2><p>像上一节那样，如果我们要区分<code>Tree Shaking</code>的开发环境和生产环境，那么我们每次打包的都要去更改<code>webpack.config.js</code>文件，有没有什么办法能让我们少改一点代码呢？ 答案是有的！<br>::: tip 说明<br>区分开发环境和生产环境，最好的办法是把公用配置提取到一个配置文件，生产环境和开发环境只写自己需要的配置，在打包的时候再进行合并即可，**<code>webpack-merge</code>** 可以帮我们做到这个事情。<br>:::</p>
<p>首先，我们效仿各大框架的脚手架的形式，把 Webpack 相关的配置都放在根目录下的<code>build</code>文件夹下，所以我们需要新建一个<code>build</code>文件夹，随后我们要在此文件夹下新建三个<code>.js</code>文件和删除<code>webpack.config.js</code>，它们分别是：</p>
<ul>
<li><code>webpack.common.js</code>：Webpack 公用配置文件</li>
<li><code>webpack.dev.js</code>：开发环境下的 Webpack 配置文件</li>
<li><code>webpack.prod.js</code>：生产环境下的 Webpack 配置文件</li>
<li><code>webpack.config.js</code>：<strong>删除</strong>根目录下的此文件</li>
</ul>
<p>新建完<code>webpack.common.js</code>文件后，我们需要把公用配置提取出来，它的代码看起来应该是下面这样子的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; CleanWebpackPlugin &#125; = <span class="built_in">require</span>(<span class="string">&#x27;clean-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">&#x27;./src/index.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: [<span class="string">&#x27;style-loader&#x27;</span>,<span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; </span><br><span class="line">        test: <span class="regexp">/\.js$/</span>, </span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>, </span><br><span class="line">        loader: <span class="string">&quot;babel-loader&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">      template: <span class="string">&#x27;src/index.html&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin()</span><br><span class="line">  ],</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">    path: path.resolve(__dirname,<span class="string">&#x27;dist&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提取完 Webpack 公用配置文件后，我们开发环境下的配置，也就是<code>webpack.dev.js</code>中的代码，将剩下下面这些：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;cheap-module-eval-source-map&#x27;</span>,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    contentBase: <span class="string">&#x27;dist&#x27;</span>,</span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    port: <span class="number">3000</span>,</span><br><span class="line">    hot: <span class="literal">true</span>,</span><br><span class="line">    hotOnly: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而生产环境下的配置，也就是<code>webpack.prod.js</code>中的代码，可能是下面这样子的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;cheap-module-source-map&#x27;</span>,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    usedExports: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理完以上三个<code>.js</code>文件后，我们需要做一件事情：</p>
<ul>
<li>当处于开发环境下时，把<code>webpack.common.js</code>中的配置和<code>webpack.dev.js</code>中的配置合并在一起</li>
<li>当处于开发环境下时，把<code>webpack.common.js</code>中的配置和<code>webpack.prod.js</code>中的配置合并在一起</li>
</ul>
<p>针对以上问题，我们可以使用<code>webpack-merge</code>进行合并，在使用之前，我们需要使用如下命令进行安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install webpack-merge -D</span><br></pre></td></tr></table></figure>

<p>安装完毕后，我们需要对<code>webpack.dev.js</code>和<code>webpack.prod.js</code>做一下手脚，其中<code>webpack.dev.js</code>中的改动如下(代码高亮部分)：</p>
<figure class="highlight js"><figcaption><span>&#123;2,3,4,18&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> commonConfig = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.common&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> devConfig = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;cheap-module-eval-source-map&#x27;</span>,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    contentBase: <span class="string">&#x27;dist&#x27;</span>,</span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    port: <span class="number">3000</span>,</span><br><span class="line">    hot: <span class="literal">true</span>,</span><br><span class="line">    hotOnly: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = merge(commonConfig, devConfig);</span><br></pre></td></tr></table></figure>
<p>相同的代码，<code>webpack.prod.js</code>中的改动部分如下(代码高亮)：</p>
<figure class="highlight js"><figcaption><span>&#123;1,2,3,10&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = <span class="built_in">require</span>(<span class="string">&#x27;webpack-merge&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> commonConfig = <span class="built_in">require</span>(<span class="string">&#x27;./webpack.common&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> prodConfig = &#123;</span><br><span class="line">  mode: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;cheap-module-source-map&#x27;</span>,</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    usedExports: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = merge(commonConfig, prodConfig);</span><br></pre></td></tr></table></figure>
<p>聪明的你一定想到了，因为上面我们已经删除了<code>webpack.config.js</code>文件，所以我们需要重新在<code>package.json</code>中配置一下我们的打包命令，它们是这样子写的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;dev&quot;: &quot;webpack-dev-server --config ./build/webpack.dev.js&quot;,</span><br><span class="line">  &quot;build&quot;: &quot;webpack --config ./build/webpack.prod.js&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>配置完打包命令，心急的你可能会马上开始尝试进行打包，你的打包目录可能长成下面这个样子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|-- build</span><br><span class="line">|   |-- dist</span><br><span class="line">|   |   |-- index.html</span><br><span class="line">|   |   |-- main.js</span><br><span class="line">|   |   |-- main.js.map</span><br><span class="line">|   |-- webpack.common.js</span><br><span class="line">|   |-- webpack.dev.js</span><br><span class="line">|   |-- webpack.prod.js</span><br><span class="line">|-- src</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- index.js</span><br><span class="line">|   |-- math.js</span><br><span class="line">|-- .babelrc</span><br><span class="line">|-- postcss.config.js</span><br><span class="line">|-- package.json</span><br></pre></td></tr></table></figure>
<p><strong>问题分析</strong>：当我们运行<code>npm run build</code>时，<code>dist</code>目录打包到了<code>build</code>文件夹下了，这是因为我们把Webpack 相关的配置放到了<code>build</code>文件夹下后，并没有做其他配置，Webpack 会认为<code>build</code>文件夹会是根目录，要解决这个问题，需要我们在<code>webpack.common.js</code>中修改<code>output</code>属性，具体改动的部分如下所示：</p>
<figure class="highlight"><figcaption><span>&#123;3&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">output: &#123;</span><br><span class="line">  filename: &#x27;[name].js&#x27;,</span><br><span class="line">  path: path.resolve(__dirname,&#x27;../dist&#x27;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么解决完上面这个问题，赶紧使用你的打包命令测试一下吧，我的打包目录是下面这样子，如果你按上面的配置后，你的应该跟此目录类似</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|-- build</span><br><span class="line">|   |-- webpack.common.js</span><br><span class="line">|   |-- webpack.dev.js</span><br><span class="line">|   |-- webpack.prod.js</span><br><span class="line">|-- dist</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- main.js</span><br><span class="line">|   |-- main.js.map</span><br><span class="line">|-- src</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- index.js</span><br><span class="line">|   |-- math.js</span><br><span class="line">|-- .babelrc</span><br><span class="line">|-- postcss.config.js</span><br><span class="line">|-- package.json</span><br></pre></td></tr></table></figure>

<h2 id="代码分离-CodeSplitting"><a href="#代码分离-CodeSplitting" class="headerlink" title="代码分离(CodeSplitting)"></a>代码分离(CodeSplitting)</h2><p>::: tip 理解<br><code>Code Splitting</code> 的核心是把很大的文件，分离成更小的块，让浏览器进行并行加载。<br>:::<br>常见的代码分割有三种形式：</p>
<ul>
<li>手动进行分割：例如项目如果用到<code>lodash</code>，则把<code>lodash</code>单独打包成一个文件。</li>
<li>同步导入的代码：使用 Webpack 配置进行代码分割。</li>
<li>异步导入的代码：通过模块中的内联函数调用来分割代码。</li>
</ul>
<h4 id="手动进行分割"><a href="#手动进行分割" class="headerlink" title="手动进行分割"></a>手动进行分割</h4><p>手动进行分割的意思是在<code>entry</code>上配置多个入口，例如像下面这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">    lodash: <span class="string">&#x27;lodash&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样配置后，我们使用<code>npm run build</code>打包命令，它的打包输出结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        Asset       Size  Chunks             Chunk Names</span><br><span class="line">  index.html  462 bytes          [emitted]</span><br><span class="line">    lodash.js   1.46 KiB       1  [emitted]  lodash</span><br><span class="line">lodash.js.map   5.31 KiB       1  [emitted]  lodash</span><br><span class="line">      main.js   1.56 KiB       2  [emitted]  main</span><br><span class="line">  main.js.map   5.31 KiB       2  [emitted]  main</span><br></pre></td></tr></table></figure>
<p>它输出了两个模块，也能在一定程度上进行代码分割，不过这种分割是十分脆弱的，如果两个模块共同引用了第三个模块，那么第三个模块会被同时打包进这两个入口文件中，而不是分离出来。<br/><br/></p>
<p>所以我们常见的做法是关心最后两种代码分割方法，无论是同步代码还是异步代码，都需要在<code>webpack.common.js</code>中配置<code>splitChunks</code>属性，像下面这样子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可能已经看到了其中有一个<code>chunks</code>属性，它告诉 Webpack 应该对哪些模式进行打包，它的参数有三种：</p>
<ul>
<li><code>async</code>：此值为默认值，只有异步导入的代码才会进行代码分割。</li>
<li><code>initial</code>：与<code>async</code>相对，只有同步引入的代码才会进行代码分割。</li>
<li><code>all</code>：表示无论是同步代码还是异步代码都会进行代码分割。</li>
</ul>
<h4 id="同步代码分割"><a href="#同步代码分割" class="headerlink" title="同步代码分割"></a>同步代码分割</h4><p>在完成上面的配置后，让我们来安装一个相对大一点的包，例如：<code>lodash</code>，然后对<code>index.js</code>中的代码做一些手脚，像下面这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span></span><br><span class="line"><span class="built_in">console</span>.log(_.join([<span class="string">&#x27;Dell&#x27;</span>,<span class="string">&#x27;Lee&#x27;</span>], <span class="string">&#x27; &#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>就像上面提到的那样，同步代码分割，我们只需要在<code>webpack.common.js</code>配置<code>chunks</code>属性值为<code>initial</code>即可：</p>
<figure class="highlight js"><figcaption><span>&#123;5&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">&#x27;initial&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>webpack.common.js</code>配置完毕后，我们使用<code>npm run build</code>来进行打包， 你的打包<code>dist</code>目录看起来应该像下面这样子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|-- dist</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- main.js</span><br><span class="line">|   |-- main.js.map</span><br><span class="line">|   |-- vendors~main.js</span><br><span class="line">|   |-- vendors~main.js.map</span><br></pre></td></tr></table></figure>
<p><strong>打包分析</strong>：<code>main.js</code>使我们的业务代码，<code>vendors~main.js</code>是第三方模块的代码，在此案例中也就是<code>_lodash</code>中的代码。</p>
<h4 id="异步代码分割"><a href="#异步代码分割" class="headerlink" title="异步代码分割"></a>异步代码分割</h4><p>由于<code>chunks</code>属性的默认值为<code>async</code>，如果我们只需要针对异步代码进行代码分割的话，我们只需要进行异步导入，Webpack会自动帮我们进行代码分割，异步代码分割它的配置如下：</p>
<figure class="highlight js"><figcaption><span>&#123;5&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">&#x27;async&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：由于异步导入语法目前并没有得到全面支持，需要通过 npm 安装 <code>@babel/plugin-syntax-dynamic-import</code> 插件来进行转译</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install @babel/plugin-syntax-dynamic-import -D</span><br></pre></td></tr></table></figure>
<p>安装完毕后，我们需要在根目录下的<code>.babelrc</code>文件做一下改动，像下面这样子：</p>
<figure class="highlight json"><figcaption><span>&#123;6&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;presets&quot;</span>: [[<span class="string">&quot;@babel/preset-env&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">&quot;corejs&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;useBuiltIns&quot;</span>: <span class="string">&quot;usage&quot;</span></span><br><span class="line">  &#125;]],</span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span>: [<span class="string">&quot;@babel/plugin-syntax-dynamic-import&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完毕后，我们需要对<code>index.js</code>做一下代码改动，让它使用异步导入代码块:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击页面，异步导入lodash模块</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  getComponent().then(<span class="function">(<span class="params">element</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>).appendChild(element)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComponent</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &#x27;lodash&#x27; */</span><span class="string">&#x27;lodash&#x27;</span>).then(<span class="function">(<span class="params">&#123; <span class="keyword">default</span>: _ &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">    element.innerHTML = _.join([<span class="string">&#x27;Dell&#x27;</span>, <span class="string">&#x27;lee&#x27;</span>], <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写好以上代码后，我们同样使用<code>npm run build</code>进行打包，<code>dist</code>打包目录的输出结果如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|-- dist</span><br><span class="line">|   |-- <span class="number">1.</span>js</span><br><span class="line">|   |-- <span class="number">1.</span>js.map</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- main.js</span><br><span class="line">|   |-- main.js.map</span><br></pre></td></tr></table></figure>
<p>我们在浏览器中运行<code>dist</code>目录下的<code>index.html</code>，切换到<code>network</code>面板时，我们可以发现只加载了<code>main.js</code>，如下图：</p>
<p><br/><br/></p>
<p>当我们点击页面时，才 <strong>真正开始加载</strong> 第三方模块，如下图(<code>1.js</code>)：</p>
<h2 id="SplitChunksPlugin配置参数详解"><a href="#SplitChunksPlugin配置参数详解" class="headerlink" title="SplitChunksPlugin配置参数详解"></a>SplitChunksPlugin配置参数详解</h2><p>在上一节中，我们配置了<code>splitChunks</code>属性，它能让我们进行代码分割，其实这是因为 Webpack 底层使用了 <strong><code>splitChunksPlugin</code></strong> 插件。这个插件有很多可以配置的属性，它也有一些默认的配置参数，它的默认配置参数如下所示，我们将在下面为一些常用的配置项做一些说明。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置项</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">&#x27;async&#x27;</span>,</span><br><span class="line">      minSize: <span class="number">30000</span>,</span><br><span class="line">      maxSize: <span class="number">0</span>,</span><br><span class="line">      minChunks: <span class="number">1</span>,</span><br><span class="line">      maxAsyncRequests: <span class="number">5</span>,</span><br><span class="line">      maxInitialRequests: <span class="number">3</span>,</span><br><span class="line">      automaticNameDelimiter: <span class="string">&#x27;~&#x27;</span>,</span><br><span class="line">      name: <span class="literal">true</span>,</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        vendors: &#123;</span><br><span class="line">          test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">          priority: -<span class="number">10</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">          minChunks: <span class="number">2</span>,</span><br><span class="line">          priority: -<span class="number">20</span>,</span><br><span class="line">          reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="chunks参数"><a href="#chunks参数" class="headerlink" title="chunks参数"></a>chunks参数</h4><p>此参数的含义在上一节中已详细说明，同时也配置了相应的案例，就<strong>不再次累述</strong>。</p>
<h4 id="minSize-和-maxSize"><a href="#minSize-和-maxSize" class="headerlink" title="minSize 和 maxSize"></a>minSize 和 maxSize</h4><p>::: tip 说明<br><code>minSize</code>默认值是30000，也就是30kb，当代码超过30kb时，才开始进行代码分割，小于30kb的则不会进行代码分割；与<code>minSize</code>相对的，<code>maxSize</code>默认值为0，为0表示不限制打包后文件的大小，一般这个属性不推荐设置，一定要设置的话，它的意思是：打包后的文件最大不能超过设定的值，超过的话就会进行代码分割。<br>:::<br>为了测试以上两个属性，我们来写一个小小的例子，在<code>src</code>目录下新建一个<code>math.js</code>文件，它的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建完毕后，在<code>index.js</code>中引入<code>math.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">&#x27;./math.js&#x27;</span></span><br><span class="line"><span class="built_in">console</span>.log(add(<span class="number">1</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>
<p><strong>打包分析</strong>：因为我们写的<code>math.js</code>文件的大小非常小，如果应用默认值，它是不会进行代码分割的，如果你要进一步测试<code>minSize</code>和<code>maxSize</code>，请自行修改后打包测试。</p>
<h4 id="minChunks"><a href="#minChunks" class="headerlink" title="minChunks"></a>minChunks</h4><p>::: tip 说明<br>默认值为1，表示某个模块复用的次数大于或等于一次，就进行代码分割。<br>:::<br>如果将其设置大于1，例如：<code>minChunks:2</code>，在不考虑其他模块的情况下，以下代码不会进行代码分割：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置了minChunks: 2，以下lodash不会进行代码分割，因为只使用了一次 </span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(_.join([<span class="string">&#x27;Dell&#x27;</span>, <span class="string">&#x27;Lee&#x27;</span>], <span class="string">&#x27;-&#x27;</span>));</span><br></pre></td></tr></table></figure>


<h4 id="maxAsyncRequests-和-maxInitialRequests"><a href="#maxAsyncRequests-和-maxInitialRequests" class="headerlink" title="maxAsyncRequests 和 maxInitialRequests"></a>maxAsyncRequests 和 maxInitialRequests</h4><ul>
<li><code>maxAsyncRequests</code>：它的默认值是5，代表在进行异步代码分割时，前五个会进行代码分割，超过五个的不再进行代码分割。</li>
<li><code>maxInitialRequests</code>：它的默认值是3，代表在进行同步代码分割时，前三个会进行代码分割，超过三个的不再进行代码分割。</li>
</ul>
<h4 id="automaticNameDelimiter"><a href="#automaticNameDelimiter" class="headerlink" title="automaticNameDelimiter"></a>automaticNameDelimiter</h4><p>这是一个连接符，左边是代码分割的缓存组，右边是打包的入口文件的项，例如<code>vendors~main.js</code></p>
<h4 id="cacheGroups"><a href="#cacheGroups" class="headerlink" title="cacheGroups"></a>cacheGroups</h4><p>::: tip 说明<br>在进行代码分割时，会把符合条件的放在一组，然后把一组中的所有文件打包在一起，默认配置项中有两个分组，一个是<code>vendors</code>和<code>default</code><br>:::</p>
<p><strong>vendors组：</strong> 以下代码的含义是，将所有通过引用<code>node_modules</code>文件夹下的都放在<code>vendors</code>组中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vendors: &#123;</span><br><span class="line">  test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">  priority: -<span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>default组：</strong> 默认组，意思是，不符合<code>vendors</code>的分组都将分配在<code>default</code>组中，如果一个文件即满足<code>vendors</code>分组，又满足<code>default</code>分组，那么通过<code>priority</code>的值进行取舍，值最大<strong>优先级</strong>越高。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span>: &#123;</span><br><span class="line">  minChunks: <span class="number">2</span>,</span><br><span class="line">  priority: -<span class="number">20</span>,</span><br><span class="line">  reuseExistingChunk: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>reuseExistingChunk：</strong> 中文解释是复用已存在的文件。意思是，如果有一个<code>a.js</code>文件，它里面引用了<code>b.js</code>，但我们其他模块又有引用<code>b.js</code>的地方。开启这个配置项后，在打包时会分析<code>b.js</code>已经打包过了，直接可以复用不用再次打包。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;b.js&#x27;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;a.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// c.js</span></span><br><span class="line"><span class="keyword">import</span> b <span class="keyword">from</span> <span class="string">&#x27;b.js&#x27;</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;c.js&#x27;</span>);</span><br></pre></td></tr></table></figure>


<h4 id="自定义文件名"><a href="#自定义文件名" class="headerlink" title="自定义文件名"></a>自定义文件名</h4><p>我们如果不对代码分隔后的文件进行配置的话，那么在<code>vendors</code>组里面的文件名，默认会按<code>vendors</code>+<code>main</code>(入口)的形式命名，例如：<code>vendors~main.js</code>，如果我们想要自定义配置文件名的话，则需要分情况：</p>
<ul>
<li>同步代码分隔：使用<code>filename</code>命名。</li>
<li>非同步代码分隔：使用<code>name</code>来命令。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步代码分隔</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置略</span></span><br><span class="line">  splitChunks: &#123;</span><br><span class="line">    chunks: <span class="string">&#x27;initial&#x27;</span>,</span><br><span class="line">    vendors: &#123;</span><br><span class="line">      test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">      priority: -<span class="number">10</span>,</span><br><span class="line">      filename: <span class="string">&#x27;vendors.js&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非同步代码分隔</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置略</span></span><br><span class="line">  splitChunks: &#123;</span><br><span class="line">    chunks: <span class="string">&#x27;async&#x27;</span>,</span><br><span class="line">    vendors: &#123;</span><br><span class="line">      test: <span class="regexp">/[\\/]node_modules[\\/]/</span>,</span><br><span class="line">      priority: -<span class="number">10</span>,</span><br><span class="line">      name: <span class="string">&#x27;vendors&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Lazy-Loading懒加载"><a href="#Lazy-Loading懒加载" class="headerlink" title="Lazy Loading懒加载"></a>Lazy Loading懒加载</h2><p>::: tip 理解<br><code>Lazy Loading</code>懒加载的理解是：通过异步引入代码，这里说的异步，并不是在页面一开始就加载，而是在合适的时机进行加载。<br>:::<br><code>Lazy Loading</code>懒加载的实际案例我们已经在上一小节书写了一个例子，不过我们依然可以做一下小小的改动，让它使用<code>async/await</code>进行异步加载，它的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面点击的时候才加载lodash模块</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  getComponet().then(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(element);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getComponet</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">default</span>: _ &#125;  = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &#x27;lodash&#x27; */</span> <span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">  element.innerHTML = _.join([<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>], <span class="string">&#x27;**&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上懒加载的结果与上一小节的结果类似，就不在此展示，你可以在你本地的项目中打包后自行测试和查看。</p>
<h2 id="PreLoading-和Prefetching"><a href="#PreLoading-和Prefetching" class="headerlink" title="PreLoading 和Prefetching"></a>PreLoading 和Prefetching</h2><p>::: tip 理解<br>在以上<code>Lazy Loading</code>的例子中，只有当我们在页面点击时才会加载<code>lodash</code>，也有一些模块虽然是异步导入的，但我们希望能提前进行加载，<code>PreLoading</code>和<code>Prefetching</code>可以帮助我们实现这一点，它们的用法类似，但它们还是有区别的：<code>Prefetching</code>不会跟随主进程一起下载，而是等到主进程加载完毕，带宽释放后才进行加载，<code>PreLoading</code>会随主进程一起加载。<br>:::<br>实现<code>PreLoading</code>或者<code>Prefetching</code>非常简单，我们只需要在上一节的例子中加一点点代码即可(参考高亮部分)：</p>
<figure class="highlight js"><figcaption><span>&#123;8&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面点击的时候才加载lodash模块</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  getComponet().then(<span class="function"><span class="params">element</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(element);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getComponet</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">default</span>: _ &#125;  = <span class="keyword">await</span> <span class="keyword">import</span>(<span class="comment">/* webpackPrefetch: true */</span> <span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">  element.innerHTML = _.join([<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>], <span class="string">&#x27;**&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改写完毕后，我们使用<code>npm run dev</code>或者<code>npm run build</code>进行打包，在浏览器中点击页面，我们将在<code>network</code>面板看到如下图所示：</p>
<p>相信聪明的你一定看到了<code>0.js</code>，它是<code>from disk cache</code>，那为什么？原因在于，<code>Prefetching</code>的代码它会在<code>head</code>头部，添加像这样的一段内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;prefetch&quot; as=&quot;script&quot; href=&quot;0.js&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>这样一段内容追加到<code>head</code>头部后，指示浏览器在空闲时间里去加载<code>0.js</code>，这正是<code>Prefetching</code>它所能帮我们做到的事情，而<code>PreLoading</code>的用法于此类似，请自行测试。</p>
<h2 id="CSS代码分割"><a href="#CSS代码分割" class="headerlink" title="CSS代码分割"></a>CSS代码分割</h2><p>::: tip 理解<br>当我们在使用<code>style-loader</code>和<code>css-loader</code>打包<code>.css</code>文件时会直接把CSS文件打包进<code>.js</code>文件中，然后直接把样式通过<code>&lt;style&gt;&lt;/style&gt;</code>的方式写在页面，如果我们要把CSS单独打包在一起，然后通过<code>link</code>标签引入，那么可以使用<code>mini-css-extract-plugin</code>插件进行打包。<br>:::<br>::: warning<br><del>截止到写此文档时，此插件还未支持HMR，意味着我们要使用这个插件进行打包CSS时，为了开发效率，我们需要配置在生产环境下，开发环境依然还是使用<code>style-loader</code>进行打包</del>。<br/><br><strong>此插件的最新版已支持HMR</strong>。<br>:::<br>在配置之前，我们需要使用<code>npm install</code>进行安装此插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install mini-css-extract-plugin -D</span><br></pre></td></tr></table></figure>
<p>安装完毕后，由于此插件已支持<code>HMR</code>，那我们可以把配置写在<code>webpack.common.js</code>中(以下配置为完整配置，改动参考高亮代码块)：</p>
<figure class="highlight js"><figcaption><span>&#123;4,15,16,17,18,19,36,37,38&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; CleanWebpackPlugin &#125; = <span class="built_in">require</span>(<span class="string">&#x27;clean-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> MiniCssExtractPlugin = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    main: <span class="string">&#x27;./src/index.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123; </span><br><span class="line">            loader: MiniCssExtractPlugin.loader,</span><br><span class="line">            options: &#123;</span><br><span class="line">              hmr: <span class="literal">true</span>,</span><br><span class="line">              reloadAll: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&#x27;css-loader&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; </span><br><span class="line">        test: <span class="regexp">/\.js$/</span>, </span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>, </span><br><span class="line">        loader: <span class="string">&quot;babel-loader&quot;</span> </span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">      template: <span class="string">&#x27;src/index.html&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin(),</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(&#123;</span><br><span class="line">      filename: <span class="string">&#x27;[name].css&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">    path: path.resolve(__dirname,<span class="string">&#x27;../dist&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完毕以后，我们来在<code>src</code>目录下新建一个<code>style.css</code>文件，它的代码如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: green;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们改动一下<code>index.js</code>文件，让它引入<code>style.css</code>，它的代码可以这样写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> root = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>);</span><br><span class="line">root.innerHTML = <span class="string">&#x27;Hello,world&#x27;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>npm run build</code>进行打包，<code>dist</code>打包目录如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|-- dist</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- main.css</span><br><span class="line">|   |-- main.css.map</span><br><span class="line">|   |-- main.js</span><br><span class="line">|   |-- main.js.map</span><br></pre></td></tr></table></figure>
<p>::: warning 注意<br>如果发现并没有打包生成<code>main.css</code>文件，可能是<code>Tree Shaking</code>的副作用，应该在<code>package.json</code>中添加属性<code>sideEffects:[&#39;*.css&#39;]</code><br>:::</p>
<h4 id="CSS压缩"><a href="#CSS压缩" class="headerlink" title="CSS压缩"></a>CSS压缩</h4><p>::: tip 理解<br><code>CSS</code>压缩的理解是：当我们有两个相同的样式分开写的时候，我们可以把它们合并在一起；为了减少<code>CSS</code>文件的体积，我们需要像压缩<code>JS</code>文件一样，压缩一下<code>CSS</code>文件。<br>:::<br>我们再在<code>src</code>目录下新建<code>style1.css</code>文件，内容如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">100px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>index.js</code>文件中引入此CSS文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style.css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./style1.css&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> root = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>);</span><br><span class="line">root.innerHTML = <span class="string">&#x27;Hello,world&#x27;</span></span><br></pre></td></tr></table></figure>
<p>使用打包<code>npm run build</code>打包命令，我们发现虽然插件帮我们把CSS打包在了一个文件，但并没有合并压缩。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: green;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">  <span class="attribute">line-height</span>: <span class="number">100px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要实现<code>CSS</code>的压缩，我们需要再安装一个插件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install optimize-css-assets-webpack-plugin -D</span><br></pre></td></tr></table></figure>
<p>安装完毕后我们需要再一次改写<code>webpack.common.js</code>的配置，如下：</p>
<figure class="highlight js"><figcaption><span>&#123;1,8,9,10&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> optimizaCssAssetsWebpackPlugin = <span class="built_in">require</span>(<span class="string">&#x27;optimize-css-assets-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    minimizer: [</span><br><span class="line">      <span class="keyword">new</span> optimizaCssAssetsWebpackPlugin(&#123;&#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完毕以后，我们再次使用<code>npm run build</code>进行打包，打包结果如下所示，可以看见，两个CSS文件的代码已经压缩合并了。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span>&#123;<span class="attribute">color</span>:red;<span class="attribute">line-height</span>:<span class="number">100px</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack和浏览器缓存-Caching"><a href="#Webpack和浏览器缓存-Caching" class="headerlink" title="Webpack和浏览器缓存(Caching)"></a>Webpack和浏览器缓存(Caching)</h2><p>在讲这一小节之前，让我们清理下项目目录，改写下我们的<code>index.js</code>，删除掉一些没用的文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dom = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">dom.innerHTML = _.join([<span class="string">&#x27;Dell&#x27;</span>, <span class="string">&#x27;Lee&#x27;</span>], <span class="string">&#x27;---&#x27;</span>);</span><br><span class="line"><span class="built_in">document</span>.body.append(dom);</span><br></pre></td></tr></table></figure>
<p>清理后的项目目录可能是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">|-- build</span><br><span class="line">|   |-- webpack.common.js</span><br><span class="line">|   |-- webpack.dev.js</span><br><span class="line">|   |-- webpack.prod.js</span><br><span class="line">|-- src</span><br><span class="line">    |-- index.html</span><br><span class="line">    |-- index.js</span><br><span class="line">|-- postcss.config.js</span><br><span class="line">|-- package.json</span><br></pre></td></tr></table></figure>
<p>我们使用<code>npm run build</code>打包命令，打包我们的代码，可能会生成如下的文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|-- build</span><br><span class="line">|   |-- webpack.common.js</span><br><span class="line">|   |-- webpack.dev.js</span><br><span class="line">|   |-- webpack.prod.js</span><br><span class="line">|-- dist</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- main.js</span><br><span class="line">|   |-- main.js.map</span><br><span class="line">|   |-- vendors~main.js</span><br><span class="line">|   |-- vendors~main.js.map</span><br><span class="line">|-- src</span><br><span class="line">    |-- index.html</span><br><span class="line">    |-- index.js</span><br><span class="line">|-- package.json</span><br><span class="line">|-- postcss.config.js</span><br></pre></td></tr></table></figure>
<p>我们可以看到，打包生成的<code>dist</code>目录下，文件名是<code>main.js</code>和<code>vendors~main.js</code>，如果我们把<code>dist</code>目录放在服务器部署的话，当用户第一次访问页面时，浏览器会自动把这两个<code>.js</code>文件缓存起来，下一次非强制性刷新页面时，会直接使用缓存起来的文件。<br/><br/><br>假如，我们在用户第一次刷新页面和第二次刷新页面之间，我们修改了我们的代码，并再一次部署，这个时候由于浏览器缓存了这两个<code>.js</code>文件，所以用户界面无法获取最新的代码。<br><br/><br>那么，我们有办法能解决这个问题呢，答案是<code>[contenthash]</code>占位符，它能根据文件的内容，在每一次打包时生成一个唯一的hash值，只要我们文件发生了变动，就重新生成一个hash值，没有改动的话，<code>[contenthash]</code>则不会发生变动，可以在<code>output</code>中进行配置，如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发环境下的output配置还是原来的那样，也就是webpack.common.js中的output配置</span></span><br><span class="line"><span class="comment">// 因为开发环境下，我们不用考虑缓存问题</span></span><br><span class="line"><span class="comment">// webpack.prod.js中添加output配置</span></span><br><span class="line">output: &#123;</span><br><span class="line">  filename: <span class="string">&#x27;[name].[contenthash].js&#x27;</span>,</span><br><span class="line">  chunkFilename: <span class="string">&#x27;[name].[contenthash].js&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>npm run build</code>进行打包，<code>dist</code>打包目录的结果如下所示，可以看到每一个<code>.js</code>文件都有一个唯一的<code>hash</code>值，这样配置后就能有效解决浏览器缓存的问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|-- dist</span><br><span class="line">|   |-- index.html</span><br><span class="line">|   |-- main.8bef05e11ca1dc804836.js</span><br><span class="line">|   |-- main.8bef05e11ca1dc804836.js.map</span><br><span class="line">|   |-- vendors~main.4b711ce6ccdc861de436.js</span><br><span class="line">|   |-- vendors~main.4b711ce6ccdc861de436.js.map</span><br></pre></td></tr></table></figure>

<h2 id="Shimming"><a href="#Shimming" class="headerlink" title="Shimming"></a>Shimming</h2><p>有时候我们在引入第三方库的时候，不得不处理一些全局变量的问题，例如jQuery的<code>$</code>，lodash的<code>_</code>，但由于一些老的第三方库不能直接修改它的代码，这时我们能不能定义一个全局变量，当文件中存在<code>$</code>或者<code>_</code>的时候自动的帮他们引入对应的包。<br>::: tip 解决办法<br>这个问题，可以使用<code>ProvidePlugin</code>插件来解决，这个插件已经被 Webpack 内置，无需安装，直接使用即可。<br>:::<br>在<code>src</code>目录下新建<code>jquery.ui.js</code>文件，代码如下所示，它使用了<code>jQuery</code>的<code>$</code>符号，创建这个文件目的是为了来模仿第三方库。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">UI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  $(<span class="string">&#x27;body&#x27;</span>).css(<span class="string">&#x27;background&#x27;</span>,<span class="string">&#x27;green&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建完毕后，我们修改一下<code>index.js</code>文件， 让它使用刚才我们创建的文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UI &#125; <span class="keyword">from</span> <span class="string">&#x27;./jquery.ui&#x27;</span>;</span><br><span class="line"></span><br><span class="line">UI();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dom = $(<span class="string">`&lt;div&gt;<span class="subst">$&#123;_.join([<span class="string">&#x27;Dell&#x27;</span>, <span class="string">&#x27;Lee&#x27;</span>], <span class="string">&#x27;---&#x27;</span>)&#125;</span>&lt;/div&gt;`</span>);</span><br><span class="line">$(<span class="string">&#x27;#root&#x27;</span>).append(dom);</span><br></pre></td></tr></table></figure>

<p>接下来我们使用<code>npm run dev</code>进行打包，它的结果如下：</p>
<p><strong>问题：</strong> 我们发现，根本运行不起来，报错<code>$ is not defined</code><br/><br><strong>解答：</strong> 这是因为虽然我们在<code>index.js</code>中引入的<code>jquery</code>文件，但<code>$</code>符号只能在<code>index.js</code>才有效，在<code>jquery.ui.js</code>无效，报错是因为<code>jquery.ui.js</code>中<code>$</code>符号找不到引起的。<br/></p>
<p>以上场景完美再现了我们最开始提到的问题，那么我们接下来就通过配置解决，首先在<code>webpack.common.js</code>文件中使用<code>ProvidePlugin</code>插件：<br>::: tip 说明<br>配置<code>$:&#39;jquery&#39;</code>，只要我们文件中使用了<code>$</code>符号，它就会自动帮我们引入<code>jquery</code>，相当于<code>import $ from &#39;jquery&#39;</code><br>:::</p>
<figure class="highlight js"><figcaption><span>&#123;3,13,14,15,16&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 其它配置</span></span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">      $: <span class="string">&#x27;jquery&#x27;</span>,</span><br><span class="line">      _: <span class="string">&#x27;lodash&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>打包结果：</strong> 使用<code>npm run dev</code>进行打包，打包结果如下，可以发现，项目已经可以正确运行了。</p>
<h2 id="处理全局this指向问题"><a href="#处理全局this指向问题" class="headerlink" title="处理全局this指向问题"></a>处理全局this指向问题</h2><p>我们现在来思考一个问题，一个模块中的<code>this</code>到底指向什么，是模块自身还是全局的<code>window</code>对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js代码，在浏览器中输出：false</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">this</span>===<span class="built_in">window</span>);</span><br></pre></td></tr></table></figure>
<p>如上所示，如果我们使用<code>npm run dev</code>运行项目，运行<code>index.html</code>时，会在浏览器的<code>console</code>面板输出<code>false</code>，证明在模块中<code>this</code>指向模块自身，而不是全局的<code>window</code>对象，那么我们有什么办法来解决这个问题呢？<br>::: tip 解决办法<br>安装使用<code>imports-loader</code>来解决这个问题<br>:::</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install imports-loader -D</span><br></pre></td></tr></table></figure>
<p>安装完毕后，我们在<code>webpack.common.js</code>加一点配置，在<code>.js</code>的loader处理中，添加<code>imports-loader</code></p>
<figure class="highlight js"><figcaption><span>&#123;13&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ... 其它配置</span></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123; </span><br><span class="line">        test: <span class="regexp">/\.js$/</span>, </span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>, </span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">&#x27;babel-loader&#x27;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">&#x27;imports-loader?this=&gt;window&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完毕后使用<code>npm run dev</code>来进行打包，查看<code>console</code>控制台输出<code>true</code>，证明<code>this</code>这个时候已经指向了全局<code>window</code>对象，问题解决。</p>

  </div>
  <div>
    <a href="https://github.com/Mcguffen/mcguffen.github.io/edit/myblog/source/_posts/docs/webpack/advanced.md"target="_blank">编辑</a>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/Mcguffen?tab=repositories">项目</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Webpack%E8%BF%9B%E9%98%B6"><span class="toc-number">1.</span> <span class="toc-text">Webpack进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tree-Shaking"><span class="toc-number">1.1.</span> <span class="toc-text">Tree Shaking</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SideEffects"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">SideEffects</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E5%88%86%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%92%8C%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">区分开发模式和生产模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E7%A6%BB-CodeSplitting"><span class="toc-number">1.3.</span> <span class="toc-text">代码分离(CodeSplitting)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E8%BF%9B%E8%A1%8C%E5%88%86%E5%89%B2"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">手动进行分割</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">同步代码分割</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-number">1.3.0.3.</span> <span class="toc-text">异步代码分割</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SplitChunksPlugin%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.</span> <span class="toc-text">SplitChunksPlugin配置参数详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#chunks%E5%8F%82%E6%95%B0"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">chunks参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#minSize-%E5%92%8C-maxSize"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">minSize 和 maxSize</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#minChunks"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">minChunks</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#maxAsyncRequests-%E5%92%8C-maxInitialRequests"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">maxAsyncRequests 和 maxInitialRequests</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#automaticNameDelimiter"><span class="toc-number">1.4.0.5.</span> <span class="toc-text">automaticNameDelimiter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cacheGroups"><span class="toc-number">1.4.0.6.</span> <span class="toc-text">cacheGroups</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E4%BB%B6%E5%90%8D"><span class="toc-number">1.4.0.7.</span> <span class="toc-text">自定义文件名</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lazy-Loading%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.5.</span> <span class="toc-text">Lazy Loading懒加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PreLoading-%E5%92%8CPrefetching"><span class="toc-number">1.6.</span> <span class="toc-text">PreLoading 和Prefetching</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSS%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2"><span class="toc-number">1.7.</span> <span class="toc-text">CSS代码分割</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CSS%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.7.0.1.</span> <span class="toc-text">CSS压缩</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Webpack%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98-Caching"><span class="toc-number">1.8.</span> <span class="toc-text">Webpack和浏览器缓存(Caching)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shimming"><span class="toc-number">1.9.</span> <span class="toc-text">Shimming</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%85%A8%E5%B1%80this%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.</span> <span class="toc-text">处理全局this指向问题</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/11/18/docs/webpack/advanced/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/11/18/docs/webpack/advanced/&text=Webpack进阶"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/11/18/docs/webpack/advanced/&is_video=false&description=Webpack进阶"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Webpack进阶&body=Check out this article: http://example.com/2020/11/18/docs/webpack/advanced/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/11/18/docs/webpack/advanced/&title=Webpack进阶"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/11/18/docs/webpack/advanced/&name=Webpack进阶&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/11/18/docs/webpack/advanced/&t=Webpack进阶"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2021
    Mcguffen
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/Mcguffen?tab=repositories">项目</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
